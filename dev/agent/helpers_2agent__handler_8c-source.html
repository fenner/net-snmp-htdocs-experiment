---
section: development
---
<!-- CONTENT START -->
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>agent_handler.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body bgcolor="#ffffff">
<!-- Generated by Doxygen 1.2.11 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="modules.html">Modules</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; </center>
<hr><h1>agent_handler.c</h1><div class="fragment"><pre>00001 <font class="preprocessor">#include &lt;config.h&gt;</font>
00002 
00003 <font class="preprocessor">#include &lt;sys/types.h&gt;</font>
00004 
00005 <font class="preprocessor">#if HAVE_STRING_H</font>
00006 <font class="preprocessor">#include &lt;string.h&gt;</font>
00007 <font class="preprocessor">#endif</font>
00008 
00009 <font class="preprocessor">#include &lt;mibincl.h&gt;</font>
00010 <font class="preprocessor">#include &lt;data_list.h&gt;</font>
00011 <font class="preprocessor">#include &lt;snmp_agent.h&gt;</font>
00012 <font class="preprocessor">#include &lt;agent_registry.h&gt;</font>
00013 <font class="preprocessor">#include &lt;agent_handler.h&gt;</font>
00014 <font class="comment">/***********************************************************************/</font>
00015 <font class="comment">/* New Handler based API */</font>
00016 <font class="comment">/***********************************************************************/</font>
00017 
00019 <font class="keywordtype">int</font>
00020 register_handler(handler_registration *reginfo)<font class="keyword"> </font>{
00021     mib_handler *handler;
00022     DEBUGIF(<font class="stringliteral">"handler::register"</font>)<font class="keyword"> </font>{
00023         DEBUGMSGTL((<font class="stringliteral">"handler::register"</font>, <font class="stringliteral">"Registering"</font>));
00024         <font class="keywordflow">for</font>(handler = reginfo-&gt;handler; handler;
00025             handler = handler-&gt;next) {
00026             DEBUGMSG((<font class="stringliteral">"handler::register"</font>,<font class="stringliteral">" %s"</font>, handler-&gt;handler_name));
00027         }
00028             
00029         DEBUGMSG((<font class="stringliteral">"handler::register"</font>, <font class="stringliteral">" at "</font>));
00030         <font class="keywordflow">if</font> (reginfo-&gt;rootoid) {
00031             DEBUGMSGOID((<font class="stringliteral">"handler::register"</font>, reginfo-&gt;rootoid,
00032                          reginfo-&gt;rootoid_len));
00033         } <font class="keywordflow">else</font> {
00034             DEBUGMSG((<font class="stringliteral">"handler::register"</font>, <font class="stringliteral">"[null]"</font>));
00035         }
00036         DEBUGMSG((<font class="stringliteral">"handler::register"</font>, <font class="stringliteral">"\n"</font>));
00037     }
00038 
00039     <font class="comment">/* don't let them register for absolutely nothing.  Probably a mistake */</font>
00040     <font class="keywordflow">if</font> (0 == reginfo-&gt;modes) {
00041         reginfo-&gt;modes = HANDLER_CAN_DEFAULT;
00042     }
00043 
00044     <font class="keywordflow">return</font> register_mib_context2(reginfo-&gt;handler-&gt;handler_name,
00045                          NULL, 0, 0,
00046                          reginfo-&gt;rootoid, reginfo-&gt;rootoid_len,
00047                          reginfo-&gt;priority,
00048                          reginfo-&gt;range_subid, reginfo-&gt;range_ubound,
00049                          NULL,
00050                          reginfo-&gt;contextName,
00051                          reginfo-&gt;timeout,
00052                          0, reginfo);
00053 }
00054 
00059 <font class="keywordtype">int</font>
00060 inject_handler(handler_registration *reginfo, mib_handler *handler)<font class="keyword"> </font>{
00061     DEBUGMSGTL((<font class="stringliteral">"handler:inject"</font>, <font class="stringliteral">"injecting %s before %s\n"</font>, \
00062                 handler-&gt;handler_name, reginfo-&gt;handler-&gt;handler_name));
00063     handler-&gt;next = reginfo-&gt;handler;
00064     <font class="keywordflow">if</font> (reginfo-&gt;handler)
00065         reginfo-&gt;handler-&gt;prev = handler;
00066     reginfo-&gt;handler = handler;
00067     <font class="keywordflow">return</font> SNMPERR_SUCCESS;
00068 }
00069 
00070 <font class="keywordtype">int</font> call_handlers(handler_registration *reginfo,
00071                   agent_request_info   *reqinfo,
00072                   request_info         *requests)<font class="keyword"> </font>{
00073     NodeHandler *nh;
00074     <font class="keywordtype">int</font> status;
00075     
00076     <font class="keywordflow">if</font> (reginfo == NULL || reqinfo == NULL || requests == NULL) {
00077         snmp_log(LOG_ERR, <font class="stringliteral">"call_handlers() called illegally"</font>);
00078         <font class="keywordflow">return</font>  SNMP_ERR_GENERR;
00079     }
00080 
00081     <font class="keywordflow">if</font> (reginfo-&gt;handler == NULL) {
00082         snmp_log(LOG_ERR, <font class="stringliteral">"no handler specified."</font>);
00083         <font class="keywordflow">return</font>  SNMP_ERR_GENERR;
00084     }
00085 
00086     <font class="keywordflow">switch</font>(reqinfo-&gt;mode) {
00087         <font class="keywordflow">case</font> MODE_GET:
00088         <font class="keywordflow">case</font> MODE_GETNEXT:
00089             <font class="keywordflow">if</font> (!(reginfo-&gt;modes &amp; HANDLER_CAN_GETANDGETNEXT))
00090                 <font class="keywordflow">return</font> SNMP_ERR_NOERROR; <font class="comment">/* legal */</font>
00091             <font class="keywordflow">break</font>;
00092 
00093         <font class="keywordflow">case</font> MODE_SET_RESERVE1:
00094         <font class="keywordflow">case</font> MODE_SET_RESERVE2:
00095         <font class="keywordflow">case</font> MODE_SET_ACTION:
00096         <font class="keywordflow">case</font> MODE_SET_COMMIT:
00097         <font class="keywordflow">case</font> MODE_SET_FREE:
00098         <font class="keywordflow">case</font> MODE_SET_UNDO:
00099             <font class="keywordflow">if</font> (!(reginfo-&gt;modes &amp; HANDLER_CAN_SET)) {
00100                 <font class="keywordflow">for</font>(; requests; requests = requests-&gt;next) {
00101                     set_request_error(reqinfo, requests, SNMP_ERR_NOTWRITABLE);
00102                 }
00103                 <font class="keywordflow">return</font> SNMP_ERR_NOERROR;
00104             }
00105             <font class="keywordflow">break</font>;
00106 
00107         <font class="keywordflow">case</font> MODE_GETBULK:
00108             <font class="keywordflow">if</font> (!(reginfo-&gt;modes &amp; HANDLER_CAN_GETBULK))
00109                 <font class="keywordflow">return</font> SNMP_ERR_NOERROR; <font class="comment">/* XXXWWW: should never get</font>
00110                                             here after we force a
00111                                             getbulk-&gt;getnext helper on
00112                                             them during registration
00113                                             process. */
00114             <font class="keywordflow">break</font>;
00115             
00116         <font class="keywordflow">default</font>:
00117             snmp_log(LOG_ERR, <font class="stringliteral">"unknown mode in call_handlers! bug!\n"</font>);
00118             <font class="keywordflow">return</font> SNMP_ERR_GENERR;
00119     }
00120     DEBUGMSGTL((<font class="stringliteral">"handler:calling"</font>, <font class="stringliteral">"calling main handler %s\n"</font>,
00121                  reginfo-&gt;handler-&gt;handler_name));
00122     
00123     nh = reginfo-&gt;handler-&gt;access_method;
00124     <font class="keywordflow">if</font> (!nh) {
00125         snmp_log(LOG_ERR, <font class="stringliteral">"no handler access method specified."</font>);
00126         <font class="keywordflow">return</font> SNMP_ERR_GENERR;
00127     }
00128 
00129     <font class="comment">/* XXX: define acceptable return statuses */</font>
00130     status = (*nh)(reginfo-&gt;handler, reginfo, reqinfo, requests);
00131 
00132     <font class="keywordflow">return</font> status;
00133 }
00134 
00136 <font class="keyword">inline</font> <font class="keywordtype">int</font> call_handler(mib_handler          *next_handler,
00137                         handler_registration *reginfo,
00138                         agent_request_info   *reqinfo,
00139                         request_info         *requests)<font class="keyword"> </font>{
00140     NodeHandler *nh;
00141     <font class="keywordtype">int</font> ret;
00142     
00143     <font class="keywordflow">if</font> (next_handler == NULL || reginfo == NULL || reqinfo == NULL ||
00144         requests == NULL) {
00145         snmp_log(LOG_ERR, <font class="stringliteral">"call_next_handler() called illegally"</font>);
00146         <font class="keywordflow">return</font>  SNMP_ERR_GENERR;
00147     }
00148 
00149     nh = next_handler-&gt;access_method;
00150     <font class="keywordflow">if</font> (!nh) {
00151         snmp_log(LOG_ERR, <font class="stringliteral">"no access method specified in handler %s."</font>,
00152                  next_handler-&gt;handler_name);
00153         <font class="keywordflow">return</font> SNMP_ERR_GENERR;
00154     }
00155 
00156     DEBUGMSGTL((<font class="stringliteral">"handler:calling"</font>, <font class="stringliteral">"calling handler %s\n"</font>,
00157                  next_handler-&gt;handler_name));
00158 
00159     ret = (*nh)(next_handler, reginfo, reqinfo, requests);
00160 
00161     DEBUGMSGTL((<font class="stringliteral">"handler:returned"</font>, <font class="stringliteral">"handler %s returned %d\n"</font>,
00162                  next_handler-&gt;handler_name, ret));
00163 
00164     <font class="keywordflow">return</font> ret;
00165 }
00166 
00169 <font class="keyword">inline</font> <font class="keywordtype">int</font> call_next_handler(mib_handler          *current,
00170                              handler_registration *reginfo,
00171                              agent_request_info   *reqinfo,
00172                              request_info         *requests)<font class="keyword"> </font>{
00173 
00174     <font class="keywordflow">if</font> (current == NULL || reginfo == NULL || reqinfo == NULL ||
00175         requests == NULL) {
00176         snmp_log(LOG_ERR, <font class="stringliteral">"call_next_handler() called illegally"</font>);
00177         <font class="keywordflow">return</font>  SNMP_ERR_GENERR;
00178     }
00179 
00180     <font class="keywordflow">return</font> call_handler(current-&gt;next, reginfo, reqinfo, requests);
00181 }
00182 
00184 mib_handler *
00185 create_handler(<font class="keyword">const</font> <font class="keywordtype">char</font> *name, NodeHandler *handler_access_method)<font class="keyword"> </font>{
00186     mib_handler *ret = SNMP_MALLOC_TYPEDEF(mib_handler);
00187     ret-&gt;handler_name = strdup(name);
00188     ret-&gt;access_method = handler_access_method;
00189     <font class="keywordflow">return</font> ret;
00190 }
00191 
00196 handler_registration *
00197 create_handler_registration(<font class="keyword">const</font> <font class="keywordtype">char</font> *name,
00198                             NodeHandler *handler_access_method,
00199                             oid *reg_oid, size_t reg_oid_len,
00200                             <font class="keywordtype">int</font> modes)<font class="keyword"> </font>{
00201     handler_registration *the_reg;
00202     the_reg = SNMP_MALLOC_TYPEDEF(handler_registration);
00203     <font class="keywordflow">if</font> (!the_reg)
00204         <font class="keywordflow">return</font> NULL;
00205 
00206     <font class="keywordflow">if</font> (modes)
00207         the_reg-&gt;modes = modes;
00208     <font class="keywordflow">else</font>
00209         the_reg-&gt;modes = HANDLER_CAN_DEFAULT;
00210 
00211     the_reg-&gt;handler = create_handler(name, handler_access_method);
00212     memdup(&amp;the_reg-&gt;rootoid, reg_oid, reg_oid_len * <font class="keyword">sizeof</font>(oid));
00213     the_reg-&gt;rootoid_len = reg_oid_len;
00214     <font class="keywordflow">return</font> the_reg;
00215 }
00216 
00220 <font class="keyword">inline</font> delegated_cache *
00221 create_delegated_cache(mib_handler               *handler,
00222                        handler_registration      *reginfo,
00223                        agent_request_info        *reqinfo,
00224                        request_info              *requests,
00225                        <font class="keywordtype">void</font>                      *localinfo)<font class="keyword"> </font>{
00226     delegated_cache *ret;
00227 
00228     ret = SNMP_MALLOC_TYPEDEF(delegated_cache);
00229     <font class="keywordflow">if</font> (ret) {
00230         ret-&gt;transaction_id = reqinfo-&gt;asp-&gt;pdu-&gt;transid;
00231         ret-&gt;handler = handler;
00232         ret-&gt;reginfo = reginfo;
00233         ret-&gt;reqinfo = reqinfo;
00234         ret-&gt;requests = requests;
00235         ret-&gt;localinfo = localinfo;
00236     }
00237     <font class="keywordflow">return</font> ret;
00238 }
00239 
00243 <font class="keyword">inline</font> delegated_cache *
00244 handler_check_cache(delegated_cache *dcache)<font class="keyword"></font>
00245 {
00246     <font class="keywordflow">if</font> (!dcache)
00247         <font class="keywordflow">return</font> dcache;
00248     
00249     <font class="keywordflow">if</font> (check_transaction_id(dcache-&gt;transaction_id) == SNMPERR_SUCCESS)
00250         <font class="keywordflow">return</font> dcache;
00251 
00252     <font class="keywordflow">return</font> NULL;
00253 }
00254 
00256 <font class="keywordtype">void</font>
00257 handler_mark_requests_as_delegated(request_info *requests, <font class="keywordtype">int</font> isdelegated)<font class="keyword"> </font>
00258 {
00259     <font class="keywordflow">while</font>(requests) {
00260         requests-&gt;delegated = isdelegated;
00261         requests = requests-&gt;next;
00262     }
00263 }
00264 
00265 <font class="keyword">inline</font> <font class="keywordtype">void</font>
00266 request_add_list_data(request_info *request, data_list *node)<font class="keyword"> </font>
00267 {
00268   <font class="keywordflow">if</font> (request) {
00269     <font class="keywordflow">if</font> (request-&gt;parent_data)
00270       add_list_data(&amp;request-&gt;parent_data, node);
00271     <font class="keywordflow">else</font>
00272       request-&gt;parent_data = node;
00273   }
00274 }
00275 
00276 <font class="keyword">inline</font> <font class="keywordtype">void</font> *
00277 request_get_list_data(request_info *request, <font class="keyword">const</font> <font class="keywordtype">char</font> *name)<font class="keyword"></font>
00278 {
00279   <font class="keywordflow">if</font> (request)
00280     <font class="keywordflow">return</font> get_list_data(request-&gt;parent_data,name);
00281   <font class="keywordflow">return</font> NULL;
00282 }
00283 
00284 <font class="keyword">inline</font> <font class="keywordtype">void</font>
00285 free_request_data_set(request_info *request)<font class="keyword"></font>
00286 {
00287   <font class="keywordflow">if</font> (request)
00288     free_list_data(request-&gt;parent_data);
00289 }
00290 
00291 <font class="keyword">inline</font> <font class="keywordtype">void</font>
00292 free_request_data_sets(request_info *request)<font class="keyword"> </font>
00293 {
00294   <font class="keywordflow">if</font> (request)
00295     free_all_list_data(request-&gt;parent_data);
00296 }
00297 
00299 mib_handler *
00300 find_handler_by_name(handler_registration *reginfo, <font class="keywordtype">char</font> *name)<font class="keyword"> </font>
00301 {
00302     mib_handler *it;
00303     <font class="keywordflow">for</font>(it = reginfo-&gt;handler; it; it = it-&gt;next) {
00304         <font class="keywordflow">if</font> (strcmp(it-&gt;handler_name, name) == 0)<font class="keyword"> </font>{
00305             <font class="keywordflow">return</font> it;
00306         }
00307     }
00308     <font class="keywordflow">return</font> NULL;
00309 }
00310 
00315 <font class="keywordtype">void</font> *
00316 find_handler_data_by_name(handler_registration *reginfo,
00317                           <font class="keywordtype">char</font> *name)<font class="keyword"> </font>
00318 {
00319     mib_handler *it = find_handler_by_name(reginfo, name);
00320     <font class="keywordflow">if</font> (it)
00321         <font class="keywordflow">return</font> it-&gt;myvoid;
00322     <font class="keywordflow">return</font> NULL;
00323 }
00324 
</pre></div><hr><address><small>Generated on Sat Nov 10 14:21:00 2001 for net-snmp by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.gif" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.11 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy;&nbsp;1997-2001</small></address>
</body>
</html>
<!--#include virtual="/sfbutton.html" -->
<!--#include virtual="/sfbutton.html" -->
<!-- CONTENT END -->