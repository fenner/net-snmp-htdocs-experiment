---
section: development
---
<!-- CONTENT START -->
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>snmpoops.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body bgcolor=white>
<!-- Generated by Doxygen 1.2.14 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="modules.html">Modules</a> &nbsp; <a class="qindex" href="annotated.html">Data Structures</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Data Fields</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; <a class="qindex" href="examples.html">Examples</a> &nbsp; </center>
<hr><h1>snmpoops.c</h1><div class="fragment"><pre>00001 <font class="preprocessor">#include&lt;net-snmp/net-snmp-config.h&gt;</font>
00002 <font class="preprocessor">#include&lt;net-snmp/net-snmp-includes.h&gt;</font>
00003 
00004 <font class="preprocessor">#include &lt;net-snmp/library/snmpoops.h&gt;</font>
00005 
00006 <font class="preprocessor">#define ERROROUT(n) { int i; \</font>
00007 <font class="preprocessor">                      snmp_increment_statistic(STAT_SNMPINASNPARSEERRS); \</font>
00008 <font class="preprocessor">                      for(i = 0; i &lt; n; i++) { DEBUGINDENTLESS(); }      \</font>
00009 <font class="preprocessor">                      return NULL;                                       \</font>
00010 <font class="preprocessor">                    }</font>
00011 <font class="preprocessor"></font>
00012 <font class="preprocessor">#define PARSE_SOMETHING(text, depth, TYPE, var, size) \</font>
00013 <font class="preprocessor">    DEBUGDUMPHEADER("recv", text); \</font>
00014 <font class="preprocessor">    data = asn_parse_ ## TYPE(data, length, &amp;type, var, size); \</font>
00015 <font class="preprocessor">    if (data == NULL || *length == 0) \</font>
00016 <font class="preprocessor">        ERROROUT(depth)</font>
00017 <font class="preprocessor"></font>
00018 <font class="preprocessor">#define PARSE_MALLOC_STRING(text, depth, ptr, ptrlen) \</font>
00019 <font class="preprocessor">    ultmp = *length; \</font>
00020 <font class="preprocessor">    if (!asn_parse_length(data, &amp;ultmp)) \</font>
00021 <font class="preprocessor">        ERROROUT(depth); \</font>
00022 <font class="preprocessor">    ptrlen = ultmp; \</font>
00023 <font class="preprocessor">    if (ptr != calloc(1,ptrlen)) \</font>
00024 <font class="preprocessor">        ERROROUT(depth); \</font>
00025 <font class="preprocessor">    ulen = ptrlen; \</font>
00026 <font class="preprocessor">    PARSE_SOMETHING(text, depth, string, ptr, &amp;ulen); \</font>
00027 <font class="preprocessor">    ptrlen = ulen;</font>
00028 <font class="preprocessor"></font>    
00029 
00030 <font class="preprocessor">#define PARSE_INT(text, depth) \</font>
00031 <font class="preprocessor">    DEBUGDUMPHEADER("recv", text); \</font>
00032 <font class="preprocessor">    data = asn_parse_int(data, length, &amp;type, &amp;ltmp, sizeof(ltmp)); \</font>
00033 <font class="preprocessor">    if (data == NULL || *length == 0) \</font>
00034 <font class="preprocessor">        ERROROUT(depth)</font>
00035 <font class="preprocessor"></font>
00036 <font class="preprocessor">#define PARSE_UINT(text, depth) \</font>
00037 <font class="preprocessor">    DEBUGDUMPHEADER("recv", text); \</font>
00038 <font class="preprocessor">    data = asn_parse_unsigned_int(data, length, &amp;type, &amp;ultmp, sizeof(ultmp)); \</font>
00039 <font class="preprocessor">    if (data == NULL || *length == 0) \</font>
00040 <font class="preprocessor">        ERROROUT(depth)</font>
00041 <font class="preprocessor"></font>
00042 <font class="preprocessor">#define PARSE_SEQ(text, depth) \</font>
00043 <font class="preprocessor">    ulen = *length; \</font>
00044 <font class="preprocessor">    data = asn_parse_sequence(data, &amp;ulen, &amp;type, ASN_SNMP_SEQUENCE, \</font>
00045 <font class="preprocessor">                              text); \</font>
00046 <font class="preprocessor">    if (*length &lt;= ulen) { \</font>
00047 <font class="preprocessor">        if (data == NULL) \</font>
00048 <font class="preprocessor">            ERROROUT(depth); \</font>
00049 <font class="preprocessor">   }</font>
00050 <font class="preprocessor"></font>
00051 <font class="preprocessor">#define PARSE_OPTS(depth) \</font>
00052 <font class="preprocessor">    PARSE_SEQ("oops-options", depth); \</font>
00053 <font class="preprocessor">    </font><font class="comment">/* skip it, we don't understand anything */</font> \
00054     *length -= ulen; \
00055     data += ulen; \
00056 
00057 <font class="preprocessor">#define PARSE_OID(text, depth, ptr, ptrlen) \</font>
00058 <font class="preprocessor">  ptrlen = OID_LENGTH(oidbuf); \</font>
00059 <font class="preprocessor">  PARSE_SOMETHING(text, depth, objid, oidbuf, &amp;ptrlen); \</font>
00060 <font class="preprocessor">  memdup((u_char **) &amp;ptr, (u_char *) oidbuf, sizeof(oid) * ptrlen);</font>
00061 <font class="preprocessor"></font>
00062 
00063 u_char *
00064 oops_parse_gop(netsnmp_oops_goppdu  *pdu,
00065                u_char               *data,
00066                size_t               *length,
00067                u_char              **after_header,
00068                netsnmp_session      *sess) {
00069 
00070     u_long ultmp;
00071     <font class="keywordtype">long</font> ltmp;
00072     u_char type;
00073     size_t *spec_len;
00074     size_t ulen;
00075     size_t tmplen;
00076 
00077     <font class="keywordflow">if</font> (!pdu || !data || !length || *length &lt; 2) {
00078         snmp_increment_statistic(STAT_SNMPINASNPARSEERRS);
00079         <font class="keywordflow">return</font> NULL;
00080     }
00081 
00082     PARSE_UINT(<font class="stringliteral">"Request ID"</font>, 1);
00083     pdu-&gt;request_id = ultmp;
00084 
00085     PARSE_OPTS(1);
00086 
00087     PARSE_SEQ(<font class="stringliteral">"request-objects"</font>, 1);
00088     <font class="keywordflow">return</font> oops_parse_objects(pdu, data, &amp;ulen, after_header, sess);
00089 }
00090 
00091 u_char *
00092 oops_parse_objects(netsnmp_oops_goppdu  *pdu,
00093                    u_char               *data,
00094                    size_t               *length,
00095                    u_char              **after_header,
00096                    netsnmp_session      *sess) {
00097     u_long ultmp;
00098     size_t ulen, tmplen;
00099     <font class="keywordtype">long</font> ltmp;
00100     netsnmp_oops_gopojects **objs = &amp;pdu-&gt;gopreq, *to;
00101     oid oidbuf[MAX_OID_LEN];
00102     size_t oidbuf_len;
00103     u_char type;
00104 
00105     <font class="keywordflow">if</font> (!pdu || !data || !length || !*length)
00106         <font class="keywordflow">return</font> NULL;
00107 
00108     DEBUGDUMPSECTION(<font class="stringliteral">"recv"</font>, <font class="stringliteral">"request-objects"</font>);
00109     <font class="keywordflow">while</font>(*length &amp;&amp; data) {
00110         PARSE_SEQ(<font class="stringliteral">"request-object"</font>, 2);
00111         <font class="comment">/* XXX: should decrement a temp sequence length and subtract</font>
00112 <font class="comment">           from the passed in length at the end for invalid contained</font>
00113 <font class="comment">           sequences. */</font>
00114         *length = ulen;
00115         DEBUGDUMPSECTION(<font class="stringliteral">"recv"</font>, <font class="stringliteral">"request-object"</font>);
00116 
00117         to = *objs = SNMP_MALLOC_TYPEDEF(netsnmp_oops_gopojects);
00118         objs = &amp;(to-&gt;next);
00119         
00120         PARSE_SOMETHING(<font class="stringliteral">"max-return-objects"</font>, 3, unsigned_int,
00121                         &amp;to-&gt;max_return_objects,
00122                         <font class="keyword">sizeof</font>(to-&gt;max_return_objects));
00123 
00124         PARSE_SOMETHING(<font class="stringliteral">"skip-objects"</font>, 3, unsigned_int,
00125                         &amp;to-&gt;skip_objects,
00126                         <font class="keyword">sizeof</font>(to-&gt;skip_objects));
00127 
00128         PARSE_MALLOC_STRING(<font class="stringliteral">"cursor"</font>, 3, to-&gt;cursor, to-&gt;cursor_len);
00129 
00130         ulen = <font class="keyword">sizeof</font>(to-&gt;request_flags);
00131         PARSE_SOMETHING(<font class="stringliteral">"request-flags"</font>, 3, string, to-&gt;request_flags,
00132                         &amp;ulen);
00133 
00134         PARSE_OPTS(3);
00135 
00136         PARSE_OID(<font class="stringliteral">"base-OID"</font>, 3, to-&gt;request_base_OID,
00137                   to-&gt;request_base_OID_len);
00138 
00139         PARSE_SEQ(<font class="stringliteral">"request-objects"</font>, 3);
00140         data = oops_parse_elements(&amp;to-&gt;request_element_list, data, &amp;ulen,
00141                                    after_header, sess);
00142         <font class="keywordflow">if</font> (!data)
00143             ERROROUT(3);
00144         PARSE_SEQ(<font class="stringliteral">"request-objects"</font>, 3);
00145         data = oops_parse_search_criteria(to, data, &amp;ulen, after_header, sess);
00146         <font class="keywordflow">if</font> (!data)
00147             ERROROUT(3);
00148         DEBUGINDENTLESS();
00149     }
00150     DEBUGINDENTLESS();
00151     <font class="keywordflow">return</font> data;
00152 }
00153 
00154 u_char *
00155 oops_parse_elements(netsnmp_oops_element_list **elems,
00156                     u_char                 *data,
00157                     size_t                 *length,
00158                     u_char                **after_header,
00159                     netsnmp_session        *sess) {
00160     netsnmp_oops_element_list *to;
00161     oid oidbuf[MAX_OID_LEN];
00162     size_t oidbuf_len;
00163     u_char type;
00164     size_t ulen;
00165 
00166     <font class="keywordflow">if</font> (!elems || !data || !length || !*length)
00167         <font class="keywordflow">return</font> NULL;
00168 
00169     DEBUGDUMPSECTION(<font class="stringliteral">"recv"</font>, <font class="stringliteral">"request-elements"</font>);
00170     <font class="keywordflow">while</font>(*length &amp;&amp; data) {
00171         DEBUGDUMPSECTION(<font class="stringliteral">"recv"</font>, <font class="stringliteral">"request-element"</font>);
00172 
00173         to = *elems = SNMP_MALLOC_TYPEDEF(netsnmp_oops_element_list);
00174         elems = &amp;(to-&gt;next);
00175 
00176         to-&gt;specifier.type = *data;
00177         <font class="keywordflow">switch</font> (to-&gt;specifier.type) {
00178         <font class="keywordflow">case</font> NETSNMP_SPECIFIER_INDEX:
00179             PARSE_SOMETHING(<font class="stringliteral">"index-number"</font>, 1, unsigned_int,
00180                             &amp;to-&gt;specifier.specifier.index_number,
00181                             <font class="keyword">sizeof</font>(to-&gt;specifier.specifier.index_number));
00182             <font class="keywordflow">break</font>;
00183 
00184         <font class="keywordflow">case</font> NETSNMP_SPECIFIER_ELEMENT:
00185             PARSE_SOMETHING(<font class="stringliteral">"index-number"</font>, 1, unsigned_int,
00186                             &amp;to-&gt;specifier.specifier.element_number,
00187                             <font class="keyword">sizeof</font>(to-&gt;specifier.specifier.element_number));
00188             <font class="keywordflow">break</font>;
00189 
00190         <font class="keywordflow">case</font> NETSNMP_SPECIFIER_SUBELEMENT:
00191             PARSE_OID(<font class="stringliteral">"subelement-specifier"</font>, 1,
00192                       to-&gt;specifier.specifier.subelement_specifier,
00193                       to-&gt;specifier.specifier_len);
00194             <font class="comment">/* XXX: this really should be a union OID/len */</font>
00195             to-&gt;specifier.specifier_len *= <font class="keyword">sizeof</font>(oid);
00196             
00197         <font class="keywordflow">case</font> NETSNMP_SPECIFIER_MULTSUBELEMENT:
00198             DEBUGDUMPSECTION(<font class="stringliteral">"recv"</font>, <font class="stringliteral">"mulitple-subelement"</font>);
00199             PARSE_SEQ(<font class="stringliteral">"multiple-subelement"</font>, 2);
00200             <font class="comment">/* XXX: length problems */</font>
00201             PARSE_OID(<font class="stringliteral">"element-specifire"</font>, 2,
00202                       to-&gt;specifier.specifier.multiple_subelement.element_specifier,
00203                       to-&gt;specifier.specifier.multiple_subelement.element_specifier_len);
00204             data = oops_parse_elements(&amp;to-&gt;specifier.specifier.multiple_subelement.element_list, data, &amp;ulen, after_header, sess);
00205             <font class="keywordflow">if</font> (!data)
00206                 ERROROUT(2);
00207             DEBUGINDENTLESS();
00208             <font class="keywordflow">break</font>;
00209             
00210         <font class="keywordflow">case</font> NETSNMP_SPECIFIER_SUBELEMENT_INDEX:
00211             DEBUGDUMPSECTION(<font class="stringliteral">"recv"</font>, <font class="stringliteral">"subelement-index"</font>);
00212             PARSE_SEQ(<font class="stringliteral">"subelement-index"</font>, 2);
00213             <font class="comment">/* XXX: length problems */</font>
00214             PARSE_OID(<font class="stringliteral">"element-specifire"</font>, 2,
00215                       to-&gt;specifier.specifier.subelement_index.element_specifier,
00216                       to-&gt;specifier.specifier.subelement_index.element_specifier_len);
00217             PARSE_SOMETHING(<font class="stringliteral">"element-index-number"</font>, 1, unsigned_int,
00218                             &amp;to-&gt;specifier.specifier.subelement_index.element_index_number,
00219                             <font class="keyword">sizeof</font>(to-&gt;specifier.specifier.subelement_index.element_index_number));
00220             DEBUGINDENTLESS();
00221             <font class="keywordflow">break</font>;
00222             
00223         <font class="keywordflow">default</font>:
00224             ERROROUT(1);
00225         }
00226     }
00227     <font class="keywordflow">return</font> data;
00228 }
00229 
00230 u_char *
00231 oops_parse_search_criteria(netsnmp_oops_gopojects *objs,
00232                            u_char               *data,
00233                            size_t               *length,
00234                            u_char              **after_header,
00235                            netsnmp_session      *sess) {
00236     <font class="keywordflow">if</font> (!objs || !data || !length || !*length)
00237         <font class="keywordflow">return</font> NULL;
00238 }
</pre></div><hr><address><small><!--#include virtual="/sfbutton.html" --><br>Generated on
 Mon Apr 28 23:29:02 2003 for net-snmp by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.gif" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.14 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy;&nbsp;1997-2002</small></address>
</body>
</html>
<!--#include virtual="/sfbutton.html" -->
<!-- CONTENT END -->