---
section: development
---
<!-- CONTENT START -->
  <!-- Generated by Doxygen 1.3.9.1 -->

  <div class="qindex">
    <a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class=
    "qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class=
    "qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a> | <a class=
    "qindex" href="examples.html">Examples</a>
  </div>

  <div class="nav">
    <a class="el" href="dir_000005.html">snmplib</a>
  </div>

  <h1>snmplocalsm.c</h1>

  <div class="fragment">
    <pre class="fragment">
00001 <span class="comment">/*</span>
00002 <span class="comment"> * snmplocalsm.c</span>
00003 <span class="comment"> *</span>
00004 <span class="comment"> * This code implements a security model that assumes the local user</span>
00005 <span class="comment"> * that executed the agent is the user who's attributes called</span>
00006 <span class="comment"> */</span>
00007 
00008 <span class="preprocessor">#include &lt;net-snmp/net-snmp-config.h&gt;</span>
00009 
00010 <span class="preprocessor">#include &lt;net-snmp/net-snmp-includes.h&gt;</span>
00011 
00012 <span class="preprocessor">#include &lt;net-snmp/library/snmplocalsm.h&gt;</span>
00013 
00014 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
00015 
00016 <span class="keyword">static</span> <span class="keywordtype">int</span>      localsm_session_init(<a class="code" href=
"structsnmp__session.html">netsnmp_session</a> *);
00017 <span class="keyword">static</span> <span class="keywordtype">void</span>     localsm_free_state_ref(<span class=
"keywordtype">void</span> *);
00018 <span class="keyword">static</span> <span class="keywordtype">int</span>      localsm_free_pdu(<a class="code" href=
"structsnmp__pdu.html">netsnmp_pdu</a> *);
00019 <span class="keyword">static</span> <span class="keywordtype">int</span>      localsm_clone_pdu(<a class="code" href=
"structsnmp__pdu.html">netsnmp_pdu</a> *, <a class="code" href="structsnmp__pdu.html">netsnmp_pdu</a> *);
00020 
00021 u_int next_sess_id = 1;
00022 
00024 <span class="keywordtype">void</span>
00025 init_localsm(<span class="keywordtype">void</span>)
00026 {
00027     <span class="keyword">struct </span>snmp_secmod_def *def;
00028     <span class="keywordtype">int</span> ret;
00029 
00030     def = <a class="code" href="group__util.html#ga38">SNMP_MALLOC_STRUCT</a>(snmp_secmod_def);
00031 
00032     <span class="keywordflow">if</span> (!def) {
00033         <a class="code" href="group__snmp__logging.html#ga41">snmp_log</a>(LOG_ERR,
00034                  <span class="stringliteral">"Unable to malloc snmp_secmod struct, not registering LOCALSM\n"</span>);
00035         <span class="keywordflow">return</span>;
00036     }
00037 
00038     def-&gt;encode_reverse = localsm_rgenerate_out_msg;
00039     def-&gt;decode = localsm_process_in_msg;
00040     def-&gt;session_open = localsm_session_init;
00041     def-&gt;pdu_free_state_ref = localsm_free_state_ref;
00042     def-&gt;pdu_free = localsm_free_pdu;
00043     def-&gt;pdu_clone = localsm_clone_pdu;
00044 
00045     DEBUGMSGTL((<span class="stringliteral">"localsm"</span>,<span class=
"stringliteral">"registering ourselves\n"</span>));
00046     ret = register_sec_mod(NETSNMP_LOCALSM_SECURITY_MODEL, <span class="stringliteral">"localsm"</span>, def);
00047     DEBUGMSGTL((<span class="stringliteral">"localsm"</span>,<span class="stringliteral">" returned %d\n"</span>, ret));
00048 }
00049 
00050 <span class="comment">/*</span>
00051 <span class="comment"> * Initialize specific session information (right now, just set up things to</span>
00052 <span class="comment"> * not do an engineID probe)</span>
00053 <span class="comment"> */</span>
00054 
00055 <span class="keyword">static</span> <span class="keywordtype">int</span>
00056 localsm_session_init(<a class="code" href="structsnmp__session.html">netsnmp_session</a> * sess)
00057 {
00058     DEBUGMSGTL((<span class="stringliteral">"localsm"</span>,
00059                 <span class="stringliteral">"LOCALSM: Reached our session initialization callback\n"</span>));
00060 
00061     sess-&gt;<a class="code" href="structsnmp__session.html#o3">flags</a> |= SNMP_FLAGS_DONT_PROBE;
00062 
00063     <span class="comment">/* XXX: likely needed for something: */</span>
00064     <span class="comment">/*</span>
00065 <span class="comment">    localsmsession = sess-&gt;securityInfo =</span>
00066 <span class="comment">    if (!localsmsession)</span>
00067 <span class="comment">        return SNMPERR_GENERR;</span>
00068 <span class="comment">    */</span>
00069 
00070     <span class="keywordflow">return</span> SNMPERR_SUCCESS;
00071 }
00072 
00074 <span class="keyword">static</span> <span class="keywordtype">void</span>
00075 localsm_free_state_ref(<span class="keywordtype">void</span> *ptr)
00076 {
00077     free(ptr);
00078 }
00079 
00081 <span class="keyword">static</span> <span class="keywordtype">int</span>
00082 localsm_free_pdu(<a class="code" href="structsnmp__pdu.html">netsnmp_pdu</a> *pdu)
00083 {
00084     <span class="keywordflow">return</span> SNMPERR_SUCCESS;
00085 }
00086 
00088 <span class="keyword">static</span> <span class="keywordtype">int</span>
00089 localsm_clone_pdu(<a class="code" href="structsnmp__pdu.html">netsnmp_pdu</a> *pdu, <a class="code" href=
"structsnmp__pdu.html">netsnmp_pdu</a> *pdu2)
00090 {
00091     <span class="keywordflow">return</span> SNMPERR_SUCCESS;
00092 }
00093 
00094 <span class="comment">/* asn.1 easing definitions */</span>
00095 <span class="preprocessor">#define LOCALSMBUILD_OR_ERR(fun, args, msg, desc)       \</span>
00096 <span class="preprocessor">    DEBUGDUMPHEADER("send", desc); \</span>
00097 <span class="preprocessor">    rc = fun args;            \</span>
00098 <span class="preprocessor">    DEBUGINDENTLESS();        \</span>
00099 <span class="preprocessor">    if (rc == 0) { \</span>
00100 <span class="preprocessor">        DEBUGMSGTL(("localsm",msg)); \</span>
00101 <span class="preprocessor">        retval = SNMPERR_TOO_LONG; \</span>
00102 <span class="preprocessor">        goto outerr; \</span>
00103 <span class="preprocessor">    }</span>
00104 
00105 <span class="preprocessor">#define BUILD_START_SEQ tmpoffset = *offset;</span>
00106 
00107 <span class="preprocessor">#define BUILD_END_SEQ(x) LOCALSMBUILD_OR_ERR(asn_realloc_rbuild_sequence, \</span>
00108 <span class="preprocessor">                         (wholeMsg, wholeMsgLen, offset, 1, \</span>
00109 <span class="preprocessor">                          (u_char) (ASN_SEQUENCE | ASN_CONSTRUCTOR), \</span>
00110 <span class="preprocessor">                          *offset - tmpoffset), \</span>
00111 <span class="preprocessor">                                          x, "sequence");</span>
00112 
00113 <span class="comment">/****************************************************************************</span>
00114 <span class="comment"> *</span>
00115 <span class="comment"> * localsm_generate_out_msg</span>
00116 <span class="comment"> *</span>
00117 <span class="comment"> * Parameters:</span>
00118 <span class="comment"> *      (See list below...)</span>
00119 <span class="comment"> *</span>
00120 <span class="comment"> * Returns:</span>
00121 <span class="comment"> *      SNMPERR_SUCCESS                        On success.</span>
00122 <span class="comment"> *      ... and others</span>
00123 <span class="comment"> *</span>
00124 <span class="comment"> *</span>
00125 <span class="comment"> * Generate an outgoing message.</span>
00126 <span class="comment"> *</span>
00127 <span class="comment"> ****************************************************************************/</span>
00128 
00129 <span class="keywordtype">int</span>
00130 localsm_rgenerate_out_msg(<span class="keyword">struct</span> snmp_secmod_outgoing_params *parms)
00131 {
00132     u_char         **wholeMsg = parms-&gt;wholeMsg;
00133     size_t         *offset = parms-&gt;wholeMsgOffset;
00134     <span class="keywordtype">int</span> rc;
00135     
00136     size_t         *wholeMsgLen = parms-&gt;wholeMsgLen;
00137 
00138 
00139     DEBUGMSGTL((<span class="stringliteral">"localsm"</span>, <span class=
"stringliteral">"Starting LOCALSM processing\n"</span>));
00140 
00141 
00142     <span class="comment">/*</span>
00143 <span class="comment">     * We define here what the security message section will look like:</span>
00144 <span class="comment">     * 04 00 -- null string</span>
00145 <span class="comment">     * XXX: need to actually negotiate a context engine ID?</span>
00146 <span class="comment">     * XXX: leave room for future expansion just in case?</span>
00147 <span class="comment">     */</span>
00148     DEBUGDUMPHEADER(<span class="stringliteral">"send"</span>, <span class=
"stringliteral">"localsm security parameters"</span>);
00149     rc = asn_realloc_rbuild_header(wholeMsg, wholeMsgLen, offset, 1,
00150                                      (u_char) (ASN_UNIVERSAL | ASN_PRIMITIVE
00151                                              | ASN_OCTET_STR), 0);
00152     DEBUGINDENTLESS();
00153     <span class="keywordflow">if</span> (rc == 0) {
00154         DEBUGMSGTL((<span class="stringliteral">"localsm"</span>, <span class=
"stringliteral">"building msgSecurityParameters failed.\n"</span>));
00155         <span class="keywordflow">return</span> SNMPERR_TOO_LONG;
00156     }
00157     
00158     <span class="comment">/*</span>
00159 <span class="comment">     * Copy in the msgGlobalData and msgVersion.  </span>
00160 <span class="comment">     */</span>
00161     <span class="keywordflow">while</span> ((*wholeMsgLen - *offset) &lt; parms-&gt;globalDataLen) {
00162         <span class="keywordflow">if</span> (!asn_realloc(wholeMsg, wholeMsgLen)) {
00163             DEBUGMSGTL((<span class="stringliteral">"localsm"</span>, <span class=
"stringliteral">"building global data failed.\n"</span>));
00164             <span class="keywordflow">return</span> SNMPERR_TOO_LONG;
00165         }
00166     }
00167 
00168     *offset += parms-&gt;globalDataLen;
00169     memcpy(*wholeMsg + *wholeMsgLen - *offset,
00170            parms-&gt;globalData, parms-&gt;globalDataLen);
00171 
00172     <span class="comment">/*</span>
00173 <span class="comment">     * Total packet sequence.  </span>
00174 <span class="comment">     */</span>
00175     rc = asn_realloc_rbuild_sequence(wholeMsg, wholeMsgLen, offset, 1,
00176                                      (u_char) (ASN_SEQUENCE |
00177                                                ASN_CONSTRUCTOR), *offset);
00178     <span class="keywordflow">if</span> (rc == 0) {
00179         DEBUGMSGTL((<span class="stringliteral">"localsm"</span>, <span class=
"stringliteral">"building master packet sequence failed.\n"</span>));
00180         <span class="keywordflow">return</span> SNMPERR_TOO_LONG;
00181     }
00182 
00183     DEBUGMSGTL((<span class="stringliteral">"localsm"</span>, <span class=
"stringliteral">"LOCALSM processing completed.\n"</span>));
00184     <span class="keywordflow">return</span> SNMPERR_SUCCESS;
00185 }
00186 
00187 <span class="comment">/****************************************************************************</span>
00188 <span class="comment"> *</span>
00189 <span class="comment"> * localsm_process_in_msg</span>
00190 <span class="comment"> *</span>
00191 <span class="comment"> * Parameters:</span>
00192 <span class="comment"> *      (See list below...)</span>
00193 <span class="comment"> *</span>
00194 <span class="comment"> * Returns:</span>
00195 <span class="comment"> *      LOCALSM_ERR_NO_ERROR                        On success.</span>
00196 <span class="comment"> *      LOCALSM_ERR_GENERIC_ERROR</span>
00197 <span class="comment"> *      LOCALSM_ERR_UNSUPPORTED_SECURITY_LEVEL</span>
00198 <span class="comment"> *</span>
00199 <span class="comment"> *</span>
00200 <span class="comment"> * Processes an incoming message.</span>
00201 <span class="comment"> *</span>
00202 <span class="comment"> ****************************************************************************/</span>
00203 
00204 <span class="keywordtype">int</span>
00205 localsm_process_in_msg(<span class="keyword">struct</span> snmp_secmod_incoming_params *parms)
00206 {
00207     u_char type_value;
00208     size_t octet_string_length;
00209     u_char *data_ptr;
00210 
00211     <span class="comment">/* we don't have one, so set it to 0 */</span>
00212     parms-&gt;secEngineID = strdup(<span class="stringliteral">""</span>);
00213     *parms-&gt;secEngineIDLen = 0;
00214 
00215     <span class="comment">/* if this did not come through a tunneled connection, this</span>
00216 <span class="comment">       security model is in appropriate (and would be a HUGE security</span>
00217 <span class="comment">       hole to assume otherwise) */</span>
00218     DEBUGMSGTL((<span class="stringliteral">"localsm"</span>,<span class=
"stringliteral">"checking how we got here\n"</span>));
00219     <span class="keywordflow">if</span> (!(parms-&gt;pdu-&gt;flags &amp; UCD_MSG_FLAG_TUNNELED)) {
00220         DEBUGMSGTL((<span class="stringliteral">"localsm"</span>,<span class="stringliteral">"  not tunneled\n"</span>));
00221         <span class="keywordflow">return</span> SNMPERR_USM_AUTHENTICATIONFAILURE;
00222     } <span class="keywordflow">else</span> {
00223         DEBUGMSGTL((<span class="stringliteral">"localsm"</span>,<span class="stringliteral">"  tunneled\n"</span>));
00224     }
00225 
00226 
00227     <span class="comment">/*</span>
00228 <span class="comment">     * Eat the first octet header.</span>
00229 <span class="comment">     */</span>
00230     <span class="keywordflow">if</span> ((data_ptr = asn_parse_sequence(parms-&gt;secParams, &amp;octet_string_length,
00231                                         &amp;type_value,
00232                                         (ASN_UNIVERSAL | ASN_PRIMITIVE |
00233                                          ASN_OCTET_STR),
00234                                         <span class="stringliteral">"usm first octet"</span>)) == NULL) {
00235         <span class="comment">/*</span>
00236 <span class="comment">         * RETURN parse error </span>
00237 <span class="comment">         */</span>
00238         <span class="keywordflow">return</span> -1;
00239     }
00240     strncpy(parms-&gt;secName, strdup(getenv(<span class="stringliteral">"USER"</span>)), *parms-&gt;secNameLen);
00241     *parms-&gt;secNameLen = strlen(parms-&gt;secName);
00242     DEBUGMSGTL((<span class="stringliteral">"localsm"</span>, <span class=
"stringliteral">"user: %s/%d\n"</span>, parms-&gt;secName, parms-&gt;secNameLen));
00243     
00244     *parms-&gt;scopedPdu = data_ptr;
00245     *parms-&gt;scopedPduLen = parms-&gt;wholeMsgLen - (data_ptr - parms-&gt;wholeMsg);
00246     *parms-&gt;maxSizeResponse = parms-&gt;maxMsgSize; <span class="comment">/* XXX */</span>
00247     parms-&gt;secEngineID = strdup(<span class="stringliteral">""</span>);
00248     *parms-&gt;secEngineIDLen = 0;
00249     parms-&gt;secLevel = SNMP_SEC_LEVEL_NOAUTH;
00250 <span class="comment">/*</span>
00251 <span class="comment"> * maybe set this based on the transport in the future:</span>
00252 <span class="comment"> *</span>
00253 <span class="comment">*/</span>
00254 
00255     <span class="keywordflow">if</span> (octet_string_length != 0)
00256         <span class="keywordflow">return</span> -1;
00257 
00258     <span class="keywordflow">return</span> SNMPERR_SUCCESS;
00259 }
</pre>
  </div>
  <hr size="1" />

  <address style="align: right;">
    <small>Generated on Fri Dec 30 13:47:49 2005 for net-snmp by&nbsp; <a href="http://www.doxygen.org/index.html"><img src=
    "doxygen.png" alt="doxygen" align="middle" border="0" /></a> 1.3.9.1</small>
  </address>
<!-- CONTENT END -->