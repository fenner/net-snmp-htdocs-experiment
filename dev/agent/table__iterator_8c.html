---
section: development
---
<!-- CONTENT START -->
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>table_iterator.c File Reference</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body bgcolor="#ffffff">
<!-- Generated by Doxygen 1.2.11 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="annotated.html">Data Structures</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Data Fields</a> &nbsp; <a class="qindex" href="globals.html">Globals</a> &nbsp; </center>
<hr><h1>table_iterator.c File Reference</h1><code>#include &lt;<a class="el" href="config_8h-source.html">config.h</a>&gt;</code><br>
<code>#include &lt;string.h&gt;</code><br>
<code>#include "mibincl.h"</code><br>
<code>#include "tools.h"</code><br>
<code>#include "<a class="el" href="snmp__agent_8h-source.html">snmp_agent.h</a>"</code><br>
<code>#include "<a class="el" href="table_8h-source.html">table.h</a>"</code><br>
<code>#include "<a class="el" href="serialize_8h-source.html">serialize.h</a>"</code><br>
<code>#include "<a class="el" href="table__iterator_8h-source.html">table_iterator.h</a>"</code><br>
<code>#include &lt;dmalloc.h&gt;</code><br>

<p>
<a href="table__iterator_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td nowrap align=right valign=top><a class="el" href="helpers_2agent__handler_8h.html#a8">mib_handler</a> *&nbsp;</td><td valign=bottom><a class="el" href="table__iterator_8c.html#a0">get_table_iterator_handler</a> (<a class="el" href="table_8h.html#a11">table_registration_info</a> *tabreq)</td></tr>
<tr><td nowrap align=right valign=top>int&nbsp;</td><td valign=bottom><a class="el" href="table__iterator_8c.html#a1">register_table_iterator</a> (<a class="el" href="helpers_2agent__handler_8h.html#a9">handler_registration</a> *reginfo, <a class="el" href="table_8h.html#a11">table_registration_info</a> *tabreq)</td></tr>
<tr><td nowrap align=right valign=top>int&nbsp;</td><td valign=bottom><a class="el" href="table__iterator_8c.html#a2">table_iterator_helper_handler</a> (<a class="el" href="helpers_2agent__handler_8h.html#a8">mib_handler</a> *handler, <a class="el" href="helpers_2agent__handler_8h.html#a9">handler_registration</a> *reginfo, <a class="el" href="snmp__agent_8h.html#a21">agent_request_info</a> *reqinfo, <a class="el" href="snmp__agent_8h.html#a18">request_info</a> *requests)</td></tr>
<tr><td nowrap align=right valign=top>void *&nbsp;</td><td valign=bottom><a class="el" href="table__iterator_8c.html#a3">extract_iterator_context</a> (<a class="el" href="snmp__agent_8h.html#a18">request_info</a> *request)</td></tr>
</table>
<hr><h2>Function Documentation</h2>
<a name="a3" doxytag="table_iterator.c::extract_iterator_context"></a><p>
<table width="100%" cellpadding="2" cellspacing="0" border="0">
  <tr>
    <td class="md">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> void* extract_iterator_context </td>
          <td class="md">(&nbsp;</td>
          <td class="md" nowrap><a class="el" href="snmp__agent_8h.html#a18">request_info</a> *&nbsp;</td>
          <td class="mdname1">&nbsp; <em>request</em>          </td>
          <td class="md">)&nbsp;</td>
          <td class="md"><code> [inline]</code></td>
        </tr>

      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="table__iterator_8c-source.html#l00235">235</a> of file <a class="el" href="table__iterator_8c-source.html">table_iterator.c</a>.<div class="fragment"><pre>00236 {
00237     <font class="keywordflow">return</font> <a class="code" href="helpers_2agent__handler_8h.html#a24">request_get_list_data</a>(request, <a class="code" href="table__iterator_8h.html#a0">TABLE_ITERATOR_NAME</a>);
00238 }
</pre></div>    </td>
  </tr>
</table>
<a name="a0" doxytag="table_iterator.c::get_table_iterator_handler"></a><p>
<table width="100%" cellpadding="2" cellspacing="0" border="0">
  <tr>
    <td class="md">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="helpers_2agent__handler_8h.html#a8">mib_handler</a>* get_table_iterator_handler </td>
          <td class="md">(&nbsp;</td>
          <td class="md" nowrap><a class="el" href="table_8h.html#a11">table_registration_info</a> *&nbsp;</td>
          <td class="mdname1">&nbsp; <em>tabreq</em>          </td>
          <td class="md">)&nbsp;</td>
          <td class="md"></td>
        </tr>

      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="table__iterator_8c-source.html#l00026">26</a> of file <a class="el" href="table__iterator_8c-source.html">table_iterator.c</a>.<div class="fragment"><pre>00026                                                             {
00027     <a class="code" href="structmib__handler__s.html">mib_handler</a> *me=
00028         <a class="code" href="helpers_2agent__handler_8h.html#a19">create_handler</a>(<a class="code" href="table__iterator_8h.html#a0">TABLE_ITERATOR_NAME</a>, table_iterator_helper_handler);
00029     me-&gt;<a class="code" href="structmib__handler__s.html#m1">myvoid</a> = tabreq; <font class="comment">/* we need it too, but it really is not ours */</font>
00030     <font class="keywordflow">return</font> me;
00031 }
</pre></div>    </td>
  </tr>
</table>
<a name="a1" doxytag="table_iterator.c::register_table_iterator"></a><p>
<table width="100%" cellpadding="2" cellspacing="0" border="0">
  <tr>
    <td class="md">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> int register_table_iterator </td>
          <td class="md">(&nbsp;</td>
          <td class="md" nowrap><a class="el" href="helpers_2agent__handler_8h.html#a9">handler_registration</a> *&nbsp;</td>
          <td class="mdname">&nbsp; <em>reginfo</em>, </td>
        </tr>
        <tr>
          <td></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="table_8h.html#a11">table_registration_info</a> *&nbsp;</td>
          <td class="mdname">&nbsp; <em>tabreq</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>

      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="table__iterator_8c-source.html#l00035">35</a> of file <a class="el" href="table__iterator_8c-source.html">table_iterator.c</a>.<div class="fragment"><pre>00036                                                          {
00037 <font class="preprocessor">#ifndef NOT_SERIALIZED</font>
00038     <a class="code" href="helpers_2agent__handler_8h.html#a13">inject_handler</a>(reginfo, <a class="code" href="serialize_8c.html#a0">get_serialize_handler</a>());
00039 <font class="preprocessor">#endif</font>
00040     <a class="code" href="helpers_2agent__handler_8h.html#a13">inject_handler</a>(reginfo, <a class="code" href="table__iterator_8h.html#a2">get_table_iterator_handler</a>(tabreq));
00041     <font class="keywordflow">return</font> <a class="code" href="ttest_8c.html#a1">register_table</a>(reginfo, tabreq);
00042 }
</pre></div>    </td>
  </tr>
</table>
<a name="a2" doxytag="table_iterator.c::table_iterator_helper_handler"></a><p>
<table width="100%" cellpadding="2" cellspacing="0" border="0">
  <tr>
    <td class="md">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> int table_iterator_helper_handler </td>
          <td class="md">(&nbsp;</td>
          <td class="md" nowrap><a class="el" href="helpers_2agent__handler_8h.html#a8">mib_handler</a> *&nbsp;</td>
          <td class="mdname">&nbsp; <em>handler</em>, </td>
        </tr>
        <tr>
          <td></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="helpers_2agent__handler_8h.html#a9">handler_registration</a> *&nbsp;</td>
          <td class="mdname">&nbsp; <em>reginfo</em>, </td>
        </tr>
        <tr>
          <td></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="snmp__agent_8h.html#a21">agent_request_info</a> *&nbsp;</td>
          <td class="mdname">&nbsp; <em>reqinfo</em>, </td>
        </tr>
        <tr>
          <td></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="snmp__agent_8h.html#a18">request_info</a> *&nbsp;</td>
          <td class="mdname">&nbsp; <em>requests</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>

      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="table__iterator_8c-source.html#l00045">45</a> of file <a class="el" href="table__iterator_8c-source.html">table_iterator.c</a>.<div class="fragment"><pre>00049                                          {
00050   
00051     <a class="code" href="struct__table__registration__info.html">table_registration_info</a>   *tbl_info;
00052     oid coloid[MAX_OID_LEN];
00053     size_t coloid_len;
00054     <font class="keywordtype">int</font> ret;
00055     <font class="keyword">static</font> oid myname[MAX_OID_LEN];
00056     <font class="keyword">static</font> <font class="keywordtype">int</font> myname_len;
00057     <font class="keywordtype">int</font> oldmode;
00058     
00059     tbl_info = (<a class="code" href="struct__table__registration__info.html">table_registration_info</a> *) handler-&gt;<a class="code" href="structmib__handler__s.html#m1">myvoid</a>;
00060 
00061     <font class="comment">/* copy in the table registration oid for later use */</font>
00062     coloid_len = reginfo-&gt;<a class="code" href="structhandler__registration__s.html#m3">rootoid_len</a>+2;
00063     memcpy(coloid, reginfo-&gt;<a class="code" href="structhandler__registration__s.html#m2">rootoid</a>, reginfo-&gt;<a class="code" href="structhandler__registration__s.html#m3">rootoid_len</a> * <font class="keyword">sizeof</font>(oid));
00064     coloid[reginfo-&gt;<a class="code" href="structhandler__registration__s.html#m3">rootoid_len</a>] = 1; <font class="comment">/* table.entry node */</font>
00065     
00066     <font class="comment">/* illegally got here if these functions aren't defined */</font>
00067     <font class="keywordflow">if</font> (tbl_info-&gt;<a class="code" href="struct__table__registration__info.html#m5">get_first_data_point</a> == NULL ||
00068         tbl_info-&gt;<a class="code" href="struct__table__registration__info.html#m6">get_next_data_point</a> == NULL) {
00069         snmp_log(LOG_ERR, <font class="stringliteral">"table_iterator helper called without data accessor functions\n"</font>);
00070         <font class="keywordflow">return</font> SNMP_ERR_GENERR;
00071     }
00072 
00073     <font class="comment">/* XXXWWW: deal with SET caching */</font>
00074 
00075 <font class="preprocessor">#ifdef NOT_SERIALIZED</font>
00076     <font class="keywordflow">while</font>(requests) <font class="comment">/* XXX: currently only serialized */</font>
00077 <font class="preprocessor">#endif</font>
00078         {
00079         <font class="comment">/* XXXWWW: optimize by reversing loops (look through data only once) */</font>
00080         <font class="keyword">struct </font>variable_list *results = NULL;
00081         <font class="keyword">struct </font>variable_list *index_search = NULL; <font class="comment">/* WWW: move up? */</font>
00082         <a class="code" href="struct__table__request__info.html">table_request_info</a> *table_info =
00083             <a class="code" href="table_8h.html#a25">extract_table_info</a>(requests);
00084         <font class="keywordtype">void</font> *callback_loop_context = NULL;
00085         <font class="keywordtype">void</font> *callback_data_context = NULL;
00086         <font class="keywordtype">void</font> *callback_data_keep = NULL;
00087         
00088         <font class="keywordflow">if</font> (requests-&gt;<a class="code" href="structrequest__info__s.html#m5">processed</a> != 0) {
00089 <font class="preprocessor">#ifdef NOT_SERIALIZED</font>
00090             <font class="keywordflow">continue</font>;
00091 <font class="preprocessor">#else</font>
00092             <font class="keywordflow">return</font> SNMP_ERR_NOERROR;
00093 <font class="preprocessor">#endif</font>
00094         }
00095 
00096         <font class="keywordflow">if</font> (table_info-&gt;colnum &gt; tbl_info-&gt;<a class="code" href="struct__table__registration__info.html#m3">max_column</a>) {
00097             requests-&gt;<a class="code" href="structrequest__info__s.html#m5">processed</a> = 1;
00098 <font class="preprocessor">#ifdef NOT_SERIALIZED</font>
00099             <font class="keywordflow">break</font>;
00100 <font class="preprocessor">#else</font>
00101             <font class="keywordflow">return</font> SNMP_ERR_NOERROR;
00102 <font class="preprocessor">#endif</font>
00103         }
00104         
00105         index_search = snmp_clone_varbind(table_info-&gt;indexes);
00106 
00107         <font class="comment">/* below our minimum column? */</font>
00108         <font class="keywordflow">if</font> (table_info-&gt;colnum &lt; tbl_info-&gt;<a class="code" href="struct__table__registration__info.html#m2">min_column</a>) {
00109             <font class="comment">/* XXX: mem leak, index_search vs results */</font>
00110             results = (tbl_info-&gt;<a class="code" href="struct__table__registration__info.html#m5">get_first_data_point</a>)(&amp;callback_loop_context,
00111                                                        &amp;callback_data_context,
00112                                                        index_search);
00113             <font class="keywordflow">if</font> (tbl_info-&gt;<a class="code" href="struct__table__registration__info.html#m7">free_loop_context</a>)
00114                 (tbl_info-&gt;<a class="code" href="struct__table__registration__info.html#m7">free_loop_context</a>)(callback_loop_context);
00115             <font class="keywordflow">goto</font> got_results;
00116         }
00117 
00118         <font class="comment">/* XXX: do "only got some indexes" */</font>
00119         
00120         <font class="comment">/* find the next legal result to return */</font>
00121         index_search = snmp_clone_varbind(table_info-&gt;indexes);
00122         
00123         <font class="comment">/* find the first node */</font>
00124         index_search = (tbl_info-&gt;<a class="code" href="struct__table__registration__info.html#m5">get_first_data_point</a>)(&amp;callback_loop_context,
00125                                                         &amp;callback_data_context,
00126                                                         index_search);
00127 
00128         <font class="comment">/* table.entry.column node */</font>
00129         coloid[reginfo-&gt;<a class="code" href="structhandler__registration__s.html#m3">rootoid_len</a>+1] = table_info-&gt;colnum;
00130 
00131         <font class="keywordflow">switch</font>(reqinfo-&gt;<a class="code" href="structagent__request__info__s.html#m0">mode</a>) {
00132             <font class="keywordflow">case</font> <a class="code" href="snmp__agent_8h.html#a5">MODE_GETNEXT</a>:
00133             <font class="keywordflow">case</font> <a class="code" href="snmp__agent_8h.html#a6">MODE_GETBULK</a>: <font class="comment">/* XXXWWW */</font>
00134                 <font class="comment">/* loop through all data and find next one */</font>
00135                 <font class="keywordflow">while</font>(index_search) {
00136                     <font class="comment">/* compare the node with previous results */</font>
00137                     <font class="keywordflow">if</font> (<a class="code" href="ttest_8c.html#a10">check_getnext_reply</a>(requests, coloid, coloid_len,
00138                                             index_search, &amp;results))<font class="keyword"> </font>{
00139 
00140                         <font class="comment">/* result is our current choice, so keep a pointer to</font>
00141                            the data that the lower handler wants us to
00142                            remember (possibly freeing the last known "good"
00143                            result data pointer) */
00144                         <font class="keywordflow">if</font> (callback_data_keep &amp;&amp;
00145                             tbl_info-&gt;<a class="code" href="struct__table__registration__info.html#m8">free_data_context</a>) {
00146                             (tbl_info-&gt;<a class="code" href="struct__table__registration__info.html#m8">free_data_context</a>)(callback_data_keep);
00147                         }
00148                         callback_data_keep = callback_data_context;
00149 
00150                     } <font class="keywordflow">else</font> {
00151                         <font class="keywordflow">if</font> (callback_data_context &amp;&amp; tbl_info-&gt;<a class="code" href="struct__table__registration__info.html#m8">free_data_context</a>)
00152                             (tbl_info-&gt;<a class="code" href="struct__table__registration__info.html#m8">free_data_context</a>)(callback_data_context);
00153                     }
00154 
00155                     <font class="comment">/* get the next node in the data chain */</font>
00156                     index_search =
00157                         (tbl_info-&gt;<a class="code" href="struct__table__registration__info.html#m6">get_next_data_point</a>)(&amp;callback_loop_context,
00158                                                         &amp;callback_data_context,
00159                                                         index_search);
00160 
00161                     
00162                 }
00163                 <font class="keywordflow">break</font>;
00164 
00165             <font class="keywordflow">default</font>: <font class="comment">/* GET, SET, all the same...  exact search */</font>
00166                 <font class="comment">/* loop through all data till exact results are found */</font>
00167     
00168                 <font class="keywordflow">while</font>(index_search) {
00169                     build_oid_noalloc(myname, MAX_OID_LEN, &amp;myname_len,
00170                                       coloid, coloid_len, index_search);
00171                     <font class="keywordflow">if</font> (snmp_oid_compare(myname, myname_len,
00172                                          requests-&gt;<a class="code" href="structrequest__info__s.html#m0">requestvb</a>-&gt;name,
00173                                          requests-&gt;<a class="code" href="structrequest__info__s.html#m0">requestvb</a>-&gt;name_length) == 0)<font class="keyword"> </font>{
00174                         <font class="comment">/* found the exact match, so we're done */</font>
00175                         callback_data_keep = callback_data_context;
00176                         results = snmp_clone_varbind(index_search);
00177                         snmp_set_var_objid(results, myname, myname_len);
00178                         <font class="keywordflow">goto</font> got_results;
00179                     } <font class="keywordflow">else</font> {
00180                         <font class="comment">/* free not-needed data context */</font>
00181                         <font class="keywordflow">if</font> (callback_data_context &amp;&amp; tbl_info-&gt;<a class="code" href="struct__table__registration__info.html#m8">free_data_context</a>)
00182                             (tbl_info-&gt;<a class="code" href="struct__table__registration__info.html#m8">free_data_context</a>)(callback_data_context);
00183                     }
00184                     
00185                     <font class="comment">/* get the next node in the data chain */</font>
00186                     index_search =
00187                         (tbl_info-&gt;<a class="code" href="struct__table__registration__info.html#m6">get_next_data_point</a>)(&amp;callback_loop_context,
00188                                                         &amp;callback_data_context,
00189                                                         index_search);
00190                 }
00191         }
00192         
00193         <font class="comment">/* XXX: free index_search? */</font>
00194         <font class="keywordflow">if</font> (callback_loop_context &amp;&amp; tbl_info-&gt;<a class="code" href="struct__table__registration__info.html#m7">free_loop_context</a>)
00195             (tbl_info-&gt;<a class="code" href="struct__table__registration__info.html#m7">free_loop_context</a>)(callback_loop_context);
00196 
00197       got_results: <font class="comment">/* not milk */</font>
00198         
00199         <font class="keywordflow">if</font> (!results) {
00200             <font class="comment">/* no results found. */</font>
00201             <font class="comment">/* XXX: check for at least one entry at the very top */</font>
00202 <font class="preprocessor">#ifdef NOT_SERIALIZED</font>
00203             <font class="keywordflow">break</font>;
00204 <font class="preprocessor">#else</font>
00205             <font class="keywordflow">return</font> SNMP_ERR_NOERROR;
00206 <font class="preprocessor">#endif</font>
00207         }
00208         
00209         <font class="comment">/* OK, here index_search should be a pointer to the data that</font>
00210                                    we actually need to GET */
00211         snmp_set_var_objid(requests-&gt;<a class="code" href="structrequest__info__s.html#m0">requestvb</a>, results-&gt;name,
00212                            results-&gt;name_length);
00213         
00214         oldmode = reqinfo-&gt;<a class="code" href="structagent__request__info__s.html#m0">mode</a>;
00215         <font class="keywordflow">if</font> (oldmode == <a class="code" href="snmp__agent_8h.html#a5">MODE_GETNEXT</a>)
00216             reqinfo-&gt;<a class="code" href="structagent__request__info__s.html#m0">mode</a> = <a class="code" href="snmp__agent_8h.html#a4">MODE_GET</a>;
00217         <a class="code" href="helpers_2agent__handler_8h.html#a23">request_add_list_data</a>(requests, create_data_list(<a class="code" href="table__iterator_8h.html#a0">TABLE_ITERATOR_NAME</a>, callback_data_keep, NULL));
00218         ret = <a class="code" href="helpers_2agent__handler_8h.html#a18">call_next_handler</a>(handler, reginfo, reqinfo, requests);
00219         <font class="keywordflow">if</font> (oldmode == <a class="code" href="snmp__agent_8h.html#a5">MODE_GETNEXT</a>)
00220             reqinfo-&gt;<a class="code" href="structagent__request__info__s.html#m0">mode</a> = oldmode;
00221 
00222         <font class="keywordflow">if</font> (callback_data_keep &amp;&amp; tbl_info-&gt;<a class="code" href="struct__table__registration__info.html#m8">free_data_context</a>)
00223             (tbl_info-&gt;<a class="code" href="struct__table__registration__info.html#m8">free_data_context</a>)(callback_data_keep);
00224         
00225 <font class="preprocessor">#ifdef NOT_SERIALIZED</font>
00226         <font class="keywordflow">return</font> ret;
00227 <font class="preprocessor">#else</font>
00228         requests = requests-&gt;<a class="code" href="structrequest__info__s.html#m8">next</a>;
00229 <font class="preprocessor">#endif</font>
00230         }
00231     <font class="keywordflow">return</font> SNMP_ERR_NOERROR;
00232 }
</pre></div>    </td>
  </tr>
</table>
<hr><address><small>Generated on Sat Nov 10 14:09:57 2001 for net-snmp by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.gif" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.11 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy;&nbsp;1997-2001</small></address>
</body>
</html>
<!--#include virtual="/sfbutton.html" -->
<!--#include virtual="/sfbutton.html" -->
<!-- CONTENT END -->